
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FastAPI Hive Framework, modulization code layout tools, decoupling codes into cornerstones and endpoints, developer-friendly, easy to be integrated.">
      
      
      
        <link rel="canonical" href="https://fanqingsong.github.io/fastapi-hive/usecases/">
      
      
        <link rel="prev" href="../design/">
      
      
        <link rel="next" href="../reference/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>Use Cases - FastAPI Hive</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#use-cases" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="FastAPI Hive" class="md-header__button md-logo" aria-label="FastAPI Hive" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FastAPI Hive
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Use Cases
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/fanqingsong/fastapi-hive" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    fanqingsong/fastapi-hive
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="FastAPI Hive" class="md-nav__button md-logo" aria-label="FastAPI Hive" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    FastAPI Hive
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fanqingsong/fastapi-hive" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    fanqingsong/fastapi-hive
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    What
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../why/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Why
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../how/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Use Cases
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Use Cases
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-machine-learning-model-preloading-during-app-startup" class="md-nav__link">
    <span class="md-ellipsis">
      1. Machine Learning model preloading during app startup.
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Machine Learning model preloading during app startup.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#classical-disadvantages" class="md-nav__link">
    <span class="md-ellipsis">
      classical disadvantages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapi-hive-advantages" class="md-nav__link">
    <span class="md-ellipsis">
      fastapi-hive advantages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-db-orm-definition-and-table-creation-db-instance-for-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      2. DB ORM definition and table creation &amp;&amp; db instance for endpoints.
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. DB ORM definition and table creation &amp;&amp; db instance for endpoints.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#classical-disadvantages_1" class="md-nav__link">
    <span class="md-ellipsis">
      classical disadvantages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapi-hive-advantages_1" class="md-nav__link">
    <span class="md-ellipsis">
      fastapi-hive advantages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../model_description/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model Description
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-machine-learning-model-preloading-during-app-startup" class="md-nav__link">
    <span class="md-ellipsis">
      1. Machine Learning model preloading during app startup.
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Machine Learning model preloading during app startup.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#classical-disadvantages" class="md-nav__link">
    <span class="md-ellipsis">
      classical disadvantages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapi-hive-advantages" class="md-nav__link">
    <span class="md-ellipsis">
      fastapi-hive advantages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-db-orm-definition-and-table-creation-db-instance-for-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      2. DB ORM definition and table creation &amp;&amp; db instance for endpoints.
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. DB ORM definition and table creation &amp;&amp; db instance for endpoints.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#classical-disadvantages_1" class="md-nav__link">
    <span class="md-ellipsis">
      classical disadvantages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapi-hive-advantages_1" class="md-nav__link">
    <span class="md-ellipsis">
      fastapi-hive advantages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="use-cases">Use Cases</h1>
<h2 id="1-machine-learning-model-preloading-during-app-startup">1. Machine Learning model preloading during app startup.</h2>
<hr />
<p>For machine learning model, it is not suitable to load model during request, because the time cost of model loading may be too long, so the proposed method is to load model before request stage, i.e. during app startup stage.</p>
<h3 id="classical-disadvantages">classical disadvantages</h3>
<p>For the classical code layout example, it defines loading model logic func(start_app_handler) in core.event_handler.py file.</p>
<p><strong>Reference</strong>: <a href="https://github.com/eightBEC/fastapi-ml-skeleton/tree/master/fastapi_skeleton" target="_blank">https://github.com/eightBEC/fastapi-ml-skeleton/tree/master/fastapi_skeleton</a></p>
<pre><code class="language-python">from typing import Callable

from fastapi import FastAPI
from loguru import logger

from fastapi_skeleton.core.config import DEFAULT_MODEL_PATH
from fastapi_skeleton.services.models import HousePriceModel


def _startup_model(app: FastAPI) -&gt; None:
    model_path = DEFAULT_MODEL_PATH
    model_instance = HousePriceModel(model_path)
    app.state.model = model_instance


def _shutdown_model(app: FastAPI) -&gt; None:
    app.state.model = None


def start_app_handler(app: FastAPI) -&gt; Callable:
    def startup() -&gt; None:
        logger.info(&quot;Running app start handler.&quot;)
        _startup_model(app)
    return startup


def stop_app_handler(app: FastAPI) -&gt; Callable:
    def shutdown() -&gt; None:
        logger.info(&quot;Running app shutdown handler.&quot;)
        _shutdown_model(app)
    return shutdown
</code></pre>
<p>Then register start_app_handler as startup event in main.py, so model will be load when startup event happens.</p>
<pre><code class="language-python">from fastapi import FastAPI

from fastapi_skeleton.api.routes.router import api_router
from fastapi_skeleton.core.config import (API_PREFIX, APP_NAME, APP_VERSION,
                                          IS_DEBUG)
from fastapi_skeleton.core.event_handlers import (start_app_handler,
                                                  stop_app_handler)


def get_app() -&gt; FastAPI:
    fast_app = FastAPI(title=APP_NAME, version=APP_VERSION, debug=IS_DEBUG)
    fast_app.include_router(api_router, prefix=API_PREFIX)

    fast_app.add_event_handler(&quot;startup&quot;, start_app_handler(fast_app))
    fast_app.add_event_handler(&quot;shutdown&quot;, stop_app_handler(fast_app))

    return fast_app


app = get_app()
</code></pre>
<p>But for the ideal code structure, we take assumption that all codes of one service should be put in one folder together. </p>
<h3 id="fastapi-hive-advantages">fastapi-hive advantages</h3>
<p>FastAPI hive really support this code structure, and meet the preloading requirement which is implemented by regiser startup event.</p>
<p>in the below file, we use setup hook to load machine learning model before request, and save loaded model as self._app.state.house_price_model.</p>
<p>example/endpoints_package1/house_price/service/<strong>init</strong>.py</p>
<pre><code class="language-python">

from example.endpoints_package1.house_price.service.implement import HousePriceModel
from example.endpoints_package1.house_price.config import DEFAULT_MODEL_PATH
from fastapi import FastAPI
from fastapi_hive.ioc_framework.endpoint_hooks import EndpointHooks, EndpointAsyncHooks


class EndpointHooksImpl(EndpointHooks):

    def __init__(self):
        super(EndpointHooksImpl, self).__init__()

    def setup(self):
        print(&quot;call pre setup from EndpointHooksImpl (service)!!!&quot;)

        app_state = self.app_state
        app_state['house_price_model'] = HousePriceModel(DEFAULT_MODEL_PATH)

    def teardown(self):
        print(&quot;call pre teardown from EndpointHooksImpl (service)!!!&quot;)


class EndpointAsyncHooksImpl(EndpointAsyncHooks):

    def __init__(self):
        super(EndpointAsyncHooksImpl, self).__init__()

    async def setup(self):
        print(&quot;call pre setup from EndpointAsyncHooksImpl (service)!!!&quot;)

    async def teardown(self):
        print(&quot;call pre teardown from EndpointAsyncHooksImpl (service)!!!&quot;)

</code></pre>
<p>Then in router file, we implement predict endpoint which call loaded model with variable request.app.state.house_price_model</p>
<p>example/endpoints_package1/house_price/router/implement.py</p>
<pre><code class="language-python">from fastapi import APIRouter, Depends
from starlette.requests import Request

from example.cornerstone import auth

from example.endpoints_package1.house_price.schema.payload import (
    HousePredictionPayload)
from example.endpoints_package1.house_price.schema.prediction import HousePredictionResult

from example.endpoints_package1.house_price.service import HousePriceModel


router = APIRouter()


@router.post(&quot;/predict&quot;, response_model=HousePredictionResult, name=&quot;predict&quot;)
def post_predict(
    request: Request,
    authenticated: bool = Depends(auth.validate_request),
    block_data: HousePredictionPayload = None
) -&gt; HousePredictionResult:

    model: HousePriceModel = request.app.state.endpoints['endpoints_package1.house_price']['house_price_model']
    prediction: HousePredictionResult = model.predict(block_data)

    return prediction

</code></pre>
<hr />
<h2 id="2-db-orm-definition-and-table-creation-db-instance-for-endpoints">2. DB ORM definition and table creation &amp;&amp; db instance for endpoints.</h2>
<hr />
<h3 id="classical-disadvantages_1">classical disadvantages</h3>
<p>For db setting definition, sqlalchemy let user create a Base object.</p>
<p>https://fastapi.tiangolo.com/tutorial/sql-databases/</p>
<pre><code class="language-python">from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

SQLALCHEMY_DATABASE_URL = &quot;sqlite:///./sql_app.db&quot;
# SQLALCHEMY_DATABASE_URL = &quot;postgresql://user:password@postgresserver/db&quot;

engine = create_engine(
    SQLALCHEMY_DATABASE_URL, connect_args={&quot;check_same_thread&quot;: False}
)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()

</code></pre>
<p>Then every service code which need db have to define ORM model inherited from Base object.</p>
<pre><code class="language-python">from sqlalchemy import Boolean, Column, ForeignKey, Integer, String
from sqlalchemy.orm import relationship

from .database import Base


class User(Base):
    __tablename__ = &quot;users&quot;

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True, index=True)
    hashed_password = Column(String)
    is_active = Column(Boolean, default=True)

    items = relationship(&quot;Item&quot;, back_populates=&quot;owner&quot;)


class Item(Base):
    __tablename__ = &quot;items&quot;

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String, index=True)
    description = Column(String, index=True)
    owner_id = Column(Integer, ForeignKey(&quot;users.id&quot;))

    owner = relationship(&quot;User&quot;, back_populates=&quot;items&quot;)

</code></pre>
<p>Then main.py call a sentance to create all tables in DB:</p>
<p>this sentance:
models.Base.metadata.create_all(bind=engine)</p>
<pre><code class="language-python">from fastapi import Depends, FastAPI, HTTPException
from sqlalchemy.orm import Session

from . import crud, models, schemas
from .database import SessionLocal, engine

models.Base.metadata.create_all(bind=engine)

app = FastAPI()


# Dependency
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


@app.post(&quot;/users/&quot;, response_model=schemas.User)
def create_user(user: schemas.UserCreate, db: Session = Depends(get_db)):
    db_user = crud.get_user_by_email(db, email=user.email)
    if db_user:
        raise HTTPException(status_code=400, detail=&quot;Email already registered&quot;)
    return crud.create_user(db=db, user=user)


@app.get(&quot;/users/&quot;, response_model=list[schemas.User])
def read_users(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    users = crud.get_users(db, skip=skip, limit=limit)
    return users


@app.get(&quot;/users/{user_id}&quot;, response_model=schemas.User)
def read_user(user_id: int, db: Session = Depends(get_db)):
    db_user = crud.get_user(db, user_id=user_id)
    if db_user is None:
        raise HTTPException(status_code=404, detail=&quot;User not found&quot;)
    return db_user


@app.post(&quot;/users/{user_id}/items/&quot;, response_model=schemas.Item)
def create_item_for_user(
    user_id: int, item: schemas.ItemCreate, db: Session = Depends(get_db)
):
    return crud.create_user_item(db=db, item=item, user_id=user_id)


@app.get(&quot;/items/&quot;, response_model=list[schemas.Item])
def read_items(skip: int = 0, limit: int = 100, db: Session = Depends(get_db)):
    items = crud.get_items(db, skip=skip, limit=limit)
    return items

</code></pre>
<p>But there is an implicit import dependency to care during coding:
in models.py file, import Base first, then define ORM model inherited from Base,
in main.py file, call create_all function to create tables in DB.
For large project, there are many ORM model to be defined, 
It is not suitable to define all of them in one file(models.py),
So it comes to fastapi-hive framework to decoupling db function module from endpoint service module.</p>
<pre><code class="language-python">from . import crud, models, schemas
from .database import SessionLocal, engine

models.Base.metadata.create_all(bind=engine)
</code></pre>
<h3 id="fastapi-hive-advantages_1">fastapi-hive advantages</h3>
<p>Let's see How to use fastapi-hive as of db part.</p>
<p>First, create one db setting file: example/cornerstone/db/implement.py</p>
<pre><code class="language-python">

from sqlalchemy import create_engine
from sqlalchemy.orm import declarative_base
from fastapi import FastAPI
from example.cornerstone.config import DATABASE_URL
from fastapi_sqlalchemy import DBSessionMiddleware  # middleware helper
from fastapi_sqlalchemy import db  # an object to provide global access to a database session

from fastapi_hive.ioc_framework.cornerstone_container import CornerstoneMeta

Base = declarative_base()
engine = create_engine(
    DATABASE_URL,
    connect_args={&quot;check_same_thread&quot;: False},
)


def add_db_middleware(app: FastAPI, cornerstone: CornerstoneMeta):
    app.add_middleware(DBSessionMiddleware, db_url=DATABASE_URL)

    # cornerstone.state['db'] = db


def create_all_tables(app: FastAPI):
    Base.metadata.create_all(engine)  # Create tables
    print(&quot;-- call create all over ----&quot;)

</code></pre>
<p>Secondly, create db initial file, and implement hooks call.</p>
<p>example/cornerstone/db/<strong>init</strong>.py</p>
<pre><code class="language-python">import logging
import time
from fastapi_hive.ioc_framework.cornerstone_hooks import CornerstoneHooks, CornerstoneAsyncHooks
from example.cornerstone.db.implement import Base, create_all_tables, add_db_middleware
from fastapi import FastAPI
from starlette.requests import Request
from fastapi_sqlalchemy import db


__all__ = ['Base']


class CornerstoneHooksImpl(CornerstoneHooks):

    def __init__(self):
        super(CornerstoneHooksImpl, self).__init__()

    def pre_endpoint_setup(self):
        print(&quot;call pre setup from cornerstone db!!!&quot;)

        add_db_middleware(self.app, self.cornerstone)

        self.app_state['db'] = db

    def post_endpoint_setup(self):
        print(&quot;call post setup from cornerstone!!!&quot;)

        create_all_tables(self.app)

    def pre_endpoint_teardown(self):
        print(&quot;call pre teardown from cornerstone!!!&quot;)

    def post_endpoint_teardown(self):
        print(&quot;call pre teardown from cornerstone!!!&quot;)

    def pre_endpoint_call(self):
        print(&quot;call pre endpoint call from cornerstone!!!&quot;)

        self.request_state['db'] = db

    def post_endpoint_call(self):
        print(&quot;call post endpoint call from cornerstone!!!&quot;)


class CornerstoneAsyncHooksImpl(CornerstoneAsyncHooks):

    def __init__(self):
        super(CornerstoneAsyncHooksImpl, self).__init__()

    async def pre_endpoint_setup(self):
        print(&quot;call pre setup from cornerstone async!!!&quot;)

    async def post_endpoint_setup(self):
        print(&quot;call post setup from cornerstone async!!!&quot;)

    async def pre_endpoint_teardown(self):
        print(&quot;call pre teardown from cornerstone async!!!&quot;)

    async def post_endpoint_teardown(self):
        print(&quot;call pre teardown from cornerstone async!!!&quot;)

    async def pre_endpoint_call(self):
        print(&quot;call pre endpoint call from cornerstone async!!!&quot;)

    async def post_endpoint_call(self):
        print(&quot;call post endpoint call from cornerstone async!!!&quot;)

</code></pre>
<p>Third, create one endpoint db models file:</p>
<p>example/endpoints_package1/notes/db/implement.py</p>
<pre><code class="language-python">
from sqlalchemy import Column, Integer, String, Boolean

from example.cornerstone.db import Base


class Note(Base):
    __tablename__ = &quot;note&quot;

    id = Column(Integer, primary_key=True)
    text = Column(String)
    completed = Column(Boolean)

</code></pre>
<p>Lastly, create a router file to call db with ORM model:</p>
<pre><code class="language-python">
from fastapi import APIRouter
from starlette.requests import Request
from typing import List
from example.endpoints_package1.notes import schemas
from example.endpoints_package1.notes import db as dbmodel

router = APIRouter()


@router.get(&quot;&quot;, response_model=List[schemas.Note], name=&quot;query notes.&quot;)
def get_notes(req: Request, skip: int = 0, limit: int = 100):
    # db = req.app.state.cornerstones['cornerstone.db'][&quot;db&quot;].session

    db = req.state.cornerstones['cornerstone.db'][&quot;db&quot;].session
    notes = db.query(dbmodel.Note).offset(skip).limit(limit).all()
    return notes


@router.post(&quot;&quot;, response_model=schemas.Note, name=&quot;create note&quot;)
def create_note(note: schemas.NoteIn, req: Request):
    db = req.app.state.cornerstones['cornerstone.db'][&quot;db&quot;].session

    db_note = dbmodel.Note(text=note.text, completed=note.completed)
    db.add(db_note)
    db.commit()
    db.refresh(db_note)
    return db_note

</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>